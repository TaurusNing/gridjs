<body>
<canvas id="test"></canvas>
<script src="../gridjs.js"></script>
<script src="pilkft.js"></script>
<script>
var canvas = document.getElementById('test');
/*
gridjs.open('1.png', function(im) {
  var H, corners, i, im2, v,
      points = [];

  im2 = im.resize(480, 360).rotate(-90).copy().grayscale();
  H = harris(im2.pixel.G);
  corners = getHarrisPoint(H, 0.05, 10);

  gridjs.open('2.png', function(im3) {
    im3.resize(480, 360).rotate(-90).grayscale();
    v = pilkft(corners, im2.pixel.G, im3.pixel.G);
    
    im.hold();
    for (i = 0; i < v.length; i++) {
      if (v[i].v.x * v[i].v.x + v[i].v.y * v[i].v.y < 2500)
        im.plot([[v[i].x, v[i].y], [v[i].x + v[i].v.x, v[i].y + v[i].v.y]], 'kx--');
    }

    im.flush().show(canvas);
  });
});
*/

gridjs.open('gridjs_gold.jpg', function(im) {
  var H, corners, i, im2, v,
      points = [];

  im2 = im.copy().grayscale();
  H = harris(im2.pixel.G);
  corners = getHarrisPoint(H, 0.05, 10);

  for (i = 0; i < corners.length; i++) {
    points[i] = [corners[i].x, corners[i].y];
  }

  im.plot(points, 'ro').show(canvas);
});

function harris(srcArray) {
  var imx, imy, wxx, wyy, wxy, wdet, wtr, H,
      g = gridjs;

      imx = g.gauss(srcArray, 5, 1, 0);
      imy = g.gauss(srcArray, 5, 1, 1);

      wxx = g.gauss(g.square(imx), 5);
      wyy = g.gauss(g.square(imy), 5);
      wxy = g.gauss(g.mul(imx, imy), 5);

      wdet = g.minus(g.mul(wxx, wyy), g.square(wxy));
      wtr = g.add(wxx, wyy);

      H = g.div(wdet, wtr, 0);

      g.norm(H);

      return H;
}

function getHarrisPoint(harrisArray, threshold, minDistance) {
  var x, y, i, j, distance2,
      minDistance2 = minDistance * minDistance,
      index = 0,
      width = harrisArray[0].length,
      height = harrisArray.length,
      points = [];

  for (y = 0; y < height; y++) {
    for (x = 0; x < width; x++) {
      if (harrisArray[y][x] >= threshold) {
        points[index++] = {
          'x' : x,
          'y' : y,
          'h' : harrisArray[y][x]
        }
      }
    }
  }

  points.sort(function(a, b) {
    return b.h - a.h;
  });

  for (i = 0; i < points.length; i++) {
    for (j = 0; j < i; j++) {
      distance2 = (points[i].x - points[j].x) * (points[i].x - points[j].x) +
                  (points[i].y - points[j].y) * (points[i].y - points[j].y);

      if (distance2 < minDistance2) {
        points.splice(i, 1);
        i--;
        break;
      }
    }
  }

  return points;
}
</script>
</body>